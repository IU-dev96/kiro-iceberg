var P=Object.defineProperty;var k=(o,t,i)=>t in o?P(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i;var h=(o,t,i)=>k(o,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();class F{constructor(t,i,e,s,r,a,n=1){h(this,"x");h(this,"y");h(this,"width");h(this,"height");h(this,"velocity");h(this,"currentLevel");h(this,"canvasWidth");h(this,"velocityY");h(this,"isJumping");h(this,"isOnGround");h(this,"jumpStrength");h(this,"gravity");h(this,"facingDirection");h(this,"currentRotationY");h(this,"targetRotationY");h(this,"rotationAnimationProgress");h(this,"rotationAnimationDuration");this.x=t,this.y=i,this.width=e,this.height=s,this.velocity=r,this.canvasWidth=a,this.currentLevel=n,this.velocityY=0,this.isJumping=!1,this.isOnGround=!0,this.jumpStrength=-400,this.gravity=800,this.facingDirection="right",this.currentRotationY=0,this.targetRotationY=0,this.rotationAnimationProgress=1,this.rotationAnimationDuration=.15}move(t,i){this.facingDirection=t;const e=t==="left"?Math.PI:0;this.targetRotationY!==e&&(this.targetRotationY=e,this.rotationAnimationProgress=0);const s=this.velocity*i;t==="left"?this.x=Math.max(0,this.x-s):t==="right"&&(this.x=Math.min(this.canvasWidth-this.width,this.x+s))}setLevel(t){this.currentLevel=t}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}draw(t){t.fillStyle="rgba(255, 255, 255, 0.8)",t.fillRect(this.x,this.y,this.width,this.height)}updateCanvasWidth(t){this.canvasWidth=t,this.x=Math.min(this.x,this.canvasWidth-this.width)}jump(){this.isOnGround&&!this.isJumping&&(this.velocityY=this.jumpStrength,this.isJumping=!0,this.isOnGround=!1)}applyGravity(t){if(this.isJumping){this.velocityY+=this.gravity*t;const i=600;this.velocityY=Math.min(this.velocityY,i)}}land(){this.velocityY=0,this.isJumping=!1,this.isOnGround=!0}updatePhysics(t){this.applyGravity(t),this.y+=this.velocityY*t,this.updateRotation(t)}getRotationY(){return this.currentRotationY}updateRotationOnly(t){this.updateRotation(t)}updateRotation(t){if(this.rotationAnimationProgress<1){const i=this.currentRotationY;this.rotationAnimationProgress+=t/this.rotationAnimationDuration,this.rotationAnimationProgress=Math.min(1,this.rotationAnimationProgress);const e=this.rotationAnimationProgress,s=1-Math.pow(1-e,3);this.currentRotationY=i+(this.targetRotationY-i)*s}}}class w{constructor(t,i,e){h(this,"x");h(this,"y");h(this,"width");h(this,"height");h(this,"velocityX");h(this,"type");h(this,"direction");t<=2?(this.type="small-fish",this.width=20+t*5,this.height=15+t*3):t<=4?(this.type="large-fish",this.width=35+(t-2)*7,this.height=25+(t-2)*5):(this.type="shark",this.width=60+(t-4)*15,this.height=40+(t-4)*10),this.direction=Math.random()>.5?"left":"right",this.direction==="right"?this.x=-this.width:this.x=i,this.y=Math.random()*(e-this.height);const s=50+t*10;this.velocityX=this.direction==="right"?s:-s}update(t,i){this.x+=this.velocityX*t,this.direction==="right"&&this.x>i?this.x=-this.width:this.direction==="left"&&this.x+this.width<0&&(this.x=i)}draw(t){if(t.save(),this.type==="small-fish"?t.fillStyle="#4A90E2":this.type==="large-fish"?t.fillStyle="#2E5C8A":t.fillStyle="#1A3A52",t.beginPath(),this.type==="shark"){const i=this.y+this.height/2;t.moveTo(this.x,i),t.lineTo(this.x+this.width*.7,i-this.height*.3),t.lineTo(this.x+this.width,i),t.lineTo(this.x+this.width*.7,i+this.height*.3),t.closePath()}else t.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,Math.PI*2);t.fill(),t.beginPath(),this.direction==="right"?(t.moveTo(this.x,this.y+this.height/2),t.lineTo(this.x-this.width*.3,this.y),t.lineTo(this.x-this.width*.3,this.y+this.height)):(t.moveTo(this.x+this.width,this.y+this.height/2),t.lineTo(this.x+this.width*1.3,this.y),t.lineTo(this.x+this.width*1.3,this.y+this.height)),t.closePath(),t.fill(),t.restore()}}class b{constructor(t,i,e=60,s=80){h(this,"x");h(this,"y");h(this,"width");h(this,"height");h(this,"isActive");this.x=t,this.y=i,this.width=e,this.height=s,this.isActive=!0}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}checkOverlap(t){const i=t.getBounds(),e=this.getBounds();return this.isActive&&i.x<e.x+e.width&&i.x+i.width>e.x&&i.y<e.y+e.height&&i.y+i.height>e.y}}class R{constructor(t,i,e=80,s=20){h(this,"x");h(this,"y");h(this,"width");h(this,"height");h(this,"isActive");this.x=t,this.y=i,this.width=e,this.height=s,this.isActive=!0}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}checkOverlap(t){const i=t.getBounds(),e=this.getBounds(),s=i.x+i.width/2,r=i.y+i.height;return this.isActive&&s>=e.x&&s<=e.x+e.width&&r>=e.y&&r<=e.y+e.height}}class A{constructor(t,i,e,s,r="block"){h(this,"x");h(this,"y");h(this,"width");h(this,"height");h(this,"type");this.x=t,this.y=i,this.width=e,this.height=s,this.type=r}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}checkCollision(t){const i=t.getBounds(),e=this.getBounds();if(!(i.x<e.x+e.width&&i.x+i.width>e.x&&i.y<e.y+e.height&&i.y+i.height>e.y))return{collided:!1,side:null};const r=i.x+i.width/2,a=i.y+i.height/2,n=e.x+e.width/2,l=e.y+e.height/2,d=r-n,c=a-l,f=(i.width+e.width)/2-Math.abs(d),m=(i.height+e.height)/2-Math.abs(c);let g;return f<m?g=d>0?"left":"right":g=c>0?"top":"bottom",{collided:!0,side:g}}}class L{constructor(t,i,e=40,s=50){h(this,"x");h(this,"y");h(this,"width");h(this,"height");h(this,"collected");this.x=t,this.y=i,this.width=e,this.height=s,this.collected=!1}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}checkCollision(t){if(this.collected)return!1;const i=t.getBounds(),e=this.getBounds();return i.x<e.x+e.width&&i.x+i.width>e.x&&i.y<e.y+e.height&&i.y+i.height>e.y}}class Y{constructor(){h(this,"keys");h(this,"activeDirection");h(this,"enterPressed");h(this,"spacePressed");h(this,"keydownHandler");h(this,"keyupHandler");this.keys=new Map,this.activeDirection=null,this.enterPressed=!1,this.spacePressed=!1,this.keydownHandler=this.handleKeyDown.bind(this),this.keyupHandler=this.handleKeyUp.bind(this)}initialize(){window.addEventListener("keydown",this.keydownHandler),window.addEventListener("keyup",this.keyupHandler)}cleanup(){window.removeEventListener("keydown",this.keydownHandler),window.removeEventListener("keyup",this.keyupHandler)}handleKeyDown(t){const i=t.key;(i==="ArrowLeft"||i==="ArrowRight")&&(t.preventDefault(),this.keys.get(i)||(this.keys.set(i,!0),i==="ArrowLeft"?this.activeDirection="left":i==="ArrowRight"&&(this.activeDirection="right"))),i==="Enter"&&(t.preventDefault(),this.enterPressed=!0),(i===" "||i==="Spacebar")&&(t.preventDefault(),this.spacePressed=!0)}handleKeyUp(t){const i=t.key;(i==="ArrowLeft"||i==="ArrowRight")&&(t.preventDefault(),this.keys.set(i,!1),i==="ArrowLeft"&&this.activeDirection==="left"?this.keys.get("ArrowRight")?this.activeDirection="right":this.activeDirection=null:i==="ArrowRight"&&this.activeDirection==="right"&&(this.keys.get("ArrowLeft")?this.activeDirection="left":this.activeDirection=null)),i==="Enter"&&(t.preventDefault(),this.enterPressed=!1),(i===" "||i==="Spacebar")&&(t.preventDefault(),this.spacePressed=!1)}isKeyPressed(t){return this.keys.get(t)||!1}getActiveDirection(){return this.activeDirection}isEnterPressed(){return this.enterPressed}consumeEnter(){this.enterPressed=!1}isSpacePressed(){return this.spacePressed}consumeSpace(){this.spacePressed=!1}update(){}}class D{constructor(t,i){h(this,"canvasWidth");h(this,"canvasHeight");h(this,"waterLevel");h(this,"ghostImage");h(this,"imageLoaded");this.canvasWidth=t,this.canvasHeight=i,this.waterLevel=i*.1,this.ghostImage=null,this.imageLoaded=!1,this.loadGhostImage()}loadGhostImage(){this.ghostImage=new Image,this.ghostImage.onload=()=>{this.imageLoaded=!0},this.ghostImage.onerror=()=>{console.warn("Failed to load ghost image, will use fallback rendering"),this.imageLoaded=!1},this.ghostImage.src="https://kiro.dev/icon.svg?fe599162bb293ea0"}drawBackground(t,i){const e=this.canvasWidth,s=this.canvasHeight;if(i===1){const r=t.createLinearGradient(0,0,0,this.waterLevel);r.addColorStop(0,"#87CEEB"),r.addColorStop(1,"#B0E0E6"),t.fillStyle=r,t.fillRect(0,0,e,this.waterLevel);const a=t.createLinearGradient(0,this.waterLevel,0,s);a.addColorStop(0,"#4682B4"),a.addColorStop(.5,"#1E3A5F"),a.addColorStop(1,"#0F1F3F"),t.fillStyle=a,t.fillRect(0,this.waterLevel,e,s-this.waterLevel),this.drawIcebergLevel1(t,e),this.drawIcebergLevel2(t,e,s)}else{const r=t.createLinearGradient(0,this.waterLevel,0,s);r.addColorStop(0,"#4682B4"),r.addColorStop(.5,"#1E3A5F"),r.addColorStop(1,"#0F1F3F"),t.fillStyle=r,t.fillRect(0,0,e,s),this.drawIcebergLevel2(t,e,s)}}drawIcebergLevel1(t,i){const e=i/2,s=0,r=this.waterLevel;t.fillStyle="#E0F2F7",t.beginPath(),t.moveTo(e-i*.15,s),t.lineTo(e+i*.15,s),t.lineTo(e+i*.25,r),t.lineTo(e-i*.25,r),t.closePath(),t.fill(),t.fillStyle="#B8D8E0",t.beginPath(),t.moveTo(e,s),t.lineTo(e+i*.15,s),t.lineTo(e+i*.25,r),t.lineTo(e,r),t.closePath(),t.fill()}drawIcebergLevel2(t,i,e){const s=i/2,r=this.waterLevel,a=e;t.fillStyle="rgba(224, 242, 247, 0.7)",t.beginPath(),t.moveTo(s-i*.25,r),t.lineTo(s+i*.25,r),t.lineTo(s+i*.4,a),t.lineTo(s-i*.4,a),t.closePath(),t.fill(),t.fillStyle="rgba(184, 216, 224, 0.5)",t.beginPath(),t.moveTo(s,r),t.lineTo(s+i*.25,r),t.lineTo(s+i*.4,a),t.lineTo(s,a),t.closePath(),t.fill()}drawCharacter(t,i){t.save();const e=i.getRotationY(),s=i.x+i.width/2,r=i.y+i.height/2;if(t.translate(s,r),t.scale(Math.cos(e),1),t.translate(-s,-r),this.imageLoaded&&this.ghostImage)t.drawImage(this.ghostImage,i.x,i.y,i.width,i.height);else{t.fillStyle="rgba(255, 255, 255, 0.9)",t.beginPath();const a=i.y,n=i.width/2;t.arc(s,a+n,n,Math.PI,0,!1),t.rect(i.x,a+n,i.width,i.height-n),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.9)",t.beginPath();const l=i.y+i.height,d=3,c=i.width/d;t.moveTo(i.x,l-5);for(let y=0;y<d;y++){const v=i.x+y*c;t.quadraticCurveTo(v+c/2,l+5,v+c,l-5)}t.lineTo(i.x+i.width,l-10),t.lineTo(i.x,l-10),t.closePath(),t.fill();const f=i.width*.08,m=i.y+i.height*.3,g=i.width*.25;t.fillStyle="#000000",t.beginPath(),t.arc(s-g,m,f,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(s+g,m,f,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(200, 220, 255, 0.5)",t.lineWidth=2,t.beginPath(),t.arc(s,a+n,n+2,Math.PI,0,!1),t.stroke()}t.restore()}drawTrapdoor(t,i){if(!i.isActive)return;t.save(),t.fillStyle="#8B4513",t.fillRect(i.x,i.y,i.width,i.height),t.strokeStyle="#654321",t.lineWidth=2,t.beginPath(),t.moveTo(i.x+i.width/2,i.y),t.lineTo(i.x+i.width/2,i.y+i.height),t.stroke();for(let r=1;r<3;r++){t.beginPath();const a=i.y+i.height/3*r;t.moveTo(i.x,a),t.lineTo(i.x+i.width,a),t.stroke()}t.fillStyle="#FFD700";const e=i.x+i.width/2,s=i.y+i.height/2;t.beginPath(),t.arc(e,s,4,0,Math.PI*2),t.fill(),t.restore()}drawChalice(t,i){if(i.collected)return;t.save();const e=i.x+i.width/2,s=i.y,r=i.y+i.height;t.fillStyle="#FFD700",t.beginPath(),t.moveTo(e-i.width*.4,s),t.lineTo(e+i.width*.4,s),t.lineTo(e+i.width*.3,s+i.height*.6),t.lineTo(e-i.width*.3,s+i.height*.6),t.closePath(),t.fill(),t.fillRect(e-i.width*.1,s+i.height*.6,i.width*.2,i.height*.25),t.beginPath(),t.ellipse(e,r-i.height*.05,i.width*.35,i.height*.1,0,0,Math.PI*2),t.fill(),t.fillStyle="#FFED4E",t.beginPath(),t.ellipse(e-i.width*.15,s+i.height*.2,i.width*.1,i.height*.15,0,0,Math.PI*2),t.fill(),t.restore()}drawFireworks(t,i){t.save();for(const e of i){const s=e.life/e.maxLife;t.fillStyle=e.color,t.globalAlpha=s,t.beginPath(),t.arc(e.x,e.y,3,0,Math.PI*2),t.fill()}t.globalAlpha=1,t.restore()}drawWinScreen(t){t.save(),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.fillStyle="#FFD700",t.font="bold 72px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("You Win!",this.canvasWidth/2,this.canvasHeight/2),t.strokeStyle="#FFF",t.lineWidth=3,t.strokeText("You Win!",this.canvasWidth/2,this.canvasHeight/2),t.restore()}drawLoseScreen(t){t.save(),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.fillStyle="#FF4444",t.font="bold 72px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("Game Over",this.canvasWidth/2,this.canvasHeight/2),t.fillStyle="#FFF",t.font="24px Arial",t.fillText("You drowned!",this.canvasWidth/2,this.canvasHeight/2+60),t.restore()}drawObstacle(t,i){t.save(),t.fillStyle="#8B7355",t.fillRect(i.x,i.y,i.width,i.height),t.strokeStyle="#654321",t.lineWidth=2,t.strokeRect(i.x,i.y,i.width,i.height),t.strokeStyle="#A0826D",t.lineWidth=1;for(let e=1;e<3;e++){const s=i.y+i.height/3*e;t.beginPath(),t.moveTo(i.x,s),t.lineTo(i.x+i.width,s),t.stroke()}t.restore()}drawDoor(t,i,e=!1){i.isActive&&(t.save(),t.fillStyle="#8B4513",t.fillRect(i.x,i.y,i.width,i.height),t.strokeStyle="#654321",t.lineWidth=3,t.beginPath(),t.moveTo(i.x+i.width/2,i.y+5),t.lineTo(i.x+i.width/2,i.y+i.height-5),t.stroke(),t.beginPath(),t.moveTo(i.x+5,i.y+i.height/2),t.lineTo(i.x+i.width-5,i.y+i.height/2),t.stroke(),t.fillStyle="#FFD700",t.beginPath(),t.arc(i.x+i.width*.7,i.y+i.height/2,5,0,Math.PI*2),t.fill(),e&&(t.fillStyle="rgba(255, 255, 255, 0.9)",t.font="14px Arial",t.textAlign="center",t.fillText("Press ENTER",i.x+i.width/2,i.y-10)),t.restore())}drawSeaCreatures(t,i){for(const e of i)e.draw(t)}drawLevelBanner(t,i){t.save(),t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(10,10,120,40),t.strokeStyle="#FFD700",t.lineWidth=2,t.strokeRect(10,10,120,40),t.fillStyle="#FFFFFF",t.font="bold 24px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(`Level ${i}`,70,30),t.restore()}drawGround(t,i){t.save(),t.strokeStyle="#654321",t.lineWidth=3,t.beginPath(),t.moveTo(0,i),t.lineTo(this.canvasWidth,i),t.stroke(),t.restore()}drawTitanic(t,i,e){t.save(),t.fillStyle="#2C3E50",t.beginPath(),t.moveTo(i,e),t.lineTo(i+150,e),t.lineTo(i+140,e+40),t.lineTo(i+10,e+40),t.closePath(),t.fill(),t.fillStyle="#34495E",t.fillRect(i+40,e-30,70,30),t.fillStyle="#E74C3C",t.fillRect(i+50,e-50,15,20),t.fillRect(i+85,e-50,15,20),t.fillStyle="rgba(100, 100, 100, 0.5)",t.beginPath(),t.arc(i+57,e-55,8,0,Math.PI*2),t.arc(i+92,e-55,8,0,Math.PI*2),t.fill(),t.restore()}drawSplitIceberg(t,i){const e=this.canvasWidth,s=e/2,r=0,a=this.waterLevel;t.save(),t.fillStyle="#E0F2F7",t.beginPath(),t.moveTo(s-e*.15-i,r),t.lineTo(s-i,r),t.lineTo(s-i,a),t.lineTo(s-e*.25-i,a),t.closePath(),t.fill(),t.fillStyle="#E0F2F7",t.beginPath(),t.moveTo(s+i,r),t.lineTo(s+e*.15+i,r),t.lineTo(s+e*.25+i,a),t.lineTo(s+i,a),t.closePath(),t.fill(),t.fillStyle="#B8D8E0",t.beginPath(),t.moveTo(s-i,r),t.lineTo(s-i/2,r),t.lineTo(s-i/2,a),t.lineTo(s-i,a),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s+i/2,r),t.lineTo(s+i,r),t.lineTo(s+i,a),t.lineTo(s+i/2,a),t.closePath(),t.fill(),t.restore()}drawSinkingGhost(t,i,e){t.save();const r=1-e/this.canvasHeight*.7;t.globalAlpha=r;const a=i.y;i.y=a+e,this.drawCharacter(t,i),i.y=a,t.restore()}drawTimeoutGameOver(t){t.save(),t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.fillStyle="#FF6B6B",t.font="bold 72px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("Time's Up!",this.canvasWidth/2,this.canvasHeight/2-40),t.strokeStyle="#FFF",t.lineWidth=3,t.strokeText("Time's Up!",this.canvasWidth/2,this.canvasHeight/2-40),t.fillStyle="#FFFFFF",t.font="28px Arial",t.fillText("Press ENTER to restart",this.canvasWidth/2,this.canvasHeight/2+40),t.restore()}}const u={GRAVITY:800,JUMP_STRENGTH:-400,GROUND_Y:550,HORIZONTAL_SPEED:200},M=[{levelNumber:1,obstacleCount:2,obstacleMinSpacing:200,obstacleHeightRange:[30,40],obstacleWidthRange:[40,50],seaCreatureType:"small-fish",seaCreatureCount:2,seaCreatureSize:20,doorPosition:{x:700,y:470}},{levelNumber:2,obstacleCount:3,obstacleMinSpacing:180,obstacleHeightRange:[35,50],obstacleWidthRange:[45,60],seaCreatureType:"small-fish",seaCreatureCount:3,seaCreatureSize:25,doorPosition:{x:700,y:450}},{levelNumber:3,obstacleCount:4,obstacleMinSpacing:160,obstacleHeightRange:[40,60],obstacleWidthRange:[50,70],seaCreatureType:"large-fish",seaCreatureCount:3,seaCreatureSize:40,doorPosition:{x:700,y:430}},{levelNumber:4,obstacleCount:5,obstacleMinSpacing:140,obstacleHeightRange:[45,65],obstacleWidthRange:[55,75],seaCreatureType:"large-fish",seaCreatureCount:4,seaCreatureSize:50,doorPosition:{x:700,y:410}},{levelNumber:5,obstacleCount:6,obstacleMinSpacing:120,obstacleHeightRange:[50,70],obstacleWidthRange:[60,80],seaCreatureType:"shark",seaCreatureCount:4,seaCreatureSize:70,doorPosition:{x:700,y:390}},{levelNumber:6,obstacleCount:7,obstacleMinSpacing:100,obstacleHeightRange:[55,75],obstacleWidthRange:[65,85],seaCreatureType:"shark",seaCreatureCount:5,seaCreatureSize:90,doorPosition:{x:700,y:370},chalicePosition:{x:650,y:500}}];function p(o){const t=Math.max(1,Math.min(6,o));return M[t-1]}class W{constructor(t,i){h(this,"canvasWidth");h(this,"canvasHeight");h(this,"waterLevel");this.canvasWidth=t,this.canvasHeight=i,this.waterLevel=i*.1}getIcebergBounds(t){const i=t===1?0:this.waterLevel,e=t===1?this.waterLevel:this.canvasHeight;return{leftEdge:0,rightEdge:this.canvasWidth,topY:i,bottomY:e,getWidthAtY:s=>this.getWidthAtDepth(s,t)}}getWidthAtDepth(t,i){const e=this.canvasWidth/2;if(i===1){const r=.3+t/this.waterLevel*.2,a=this.canvasWidth*r/2;return{left:e-a,right:e+a}}else{const s=t-this.waterLevel,r=this.canvasHeight-this.waterLevel,n=.5+s/r*.3,l=this.canvasWidth*n/2;return{left:e-l,right:e+l}}}isWithinBounds(t,i,e,s,r){const a=this.getIcebergBounds(r);if(i<a.topY||i+s>a.bottomY)return!1;const n=i+s/2,{left:l,right:d}=a.getWidthAtY(n);return t>=l&&t+e<=d}generateTrapdoor(t){const i=this.getIcebergBounds(t),e=i.bottomY-30,{left:s,right:r}=i.getWidthAtY(e),a=100,n=s+a,l=r-a-80,d=n+Math.random()*(l-n);return new R(d,e)}generateChalice(t){if(t!==6)return null;const i=p(t);return i.chalicePosition?new L(i.chalicePosition.x,i.chalicePosition.y):null}generateObstacles(t){const i=p(t),e=[],s=u.GROUND_Y,r=100,n=i.doorPosition.x-100-r,l=i.obstacleCount*((i.obstacleWidthRange[0]+i.obstacleWidthRange[1])/2),d=n-l,c=Math.max(i.obstacleMinSpacing,d/(i.obstacleCount+1));let f=r+c;for(let m=0;m<i.obstacleCount;m++){const g=i.obstacleWidthRange[0]+Math.random()*(i.obstacleWidthRange[1]-i.obstacleWidthRange[0]),y=i.obstacleHeightRange[0]+Math.random()*(i.obstacleHeightRange[1]-i.obstacleHeightRange[0]),v=f,T=s-y,C=Math.abs(u.JUMP_STRENGTH)*Math.abs(u.JUMP_STRENGTH)/(2*u.GRAVITY);y<=C*.8&&e.push(new A(v,T,g,y,"block")),f+=g+c}return e}generateDoor(t){if(t>=6)return null;const i=p(t),r=u.GROUND_Y-80;return new b(i.doorPosition.x,r)}getLevelData(t){const i=this.getIcebergBounds(t),e=i.bottomY-30;return{levelNumber:t,icebergBounds:i,trapdoorPosition:{x:0,y:e},chalicePosition:t===2?{x:0,y:0}:void 0,floorY:e}}}class I{checkBoundary(t,i){const e=t.getBounds(),s=5;if(e.y<i.topY-s||e.y+e.height>i.bottomY+s)return!1;const r=e.y+e.height/2,{left:a,right:n}=i.getWidthAtY(r);return e.x>=a-s&&e.x+e.width<=n+s}checkTrapdoorOverlap(t,i){return i.checkOverlap(t)}checkChaliceCollision(t,i){return i.checkCollision(t)}checkObstacleCollision(t,i){return i.checkCollision(t)}checkObstacleTopCollision(t,i){const e=i.checkCollision(t);return e.collided&&e.side==="top"}resolveObstacleCollision(t,i){const e=i.checkCollision(t);if(!e.collided)return;const s=i.getBounds();switch(e.side){case"top":t.y=s.y-t.height,t.land();break;case"bottom":t.y=s.y+s.height,t.velocityY=0;break;case"left":t.x=s.x-t.width;break;case"right":t.x=s.x+s.width;break}}checkDoorOverlap(t,i){return i.checkOverlap(t)}}class B{constructor(t,i){h(this,"particles");h(this,"canvasWidth");h(this,"canvasHeight");h(this,"burstCount");h(this,"nextBurstTime");h(this,"elapsedTime");this.particles=[],this.canvasWidth=t,this.canvasHeight=i,this.burstCount=0,this.nextBurstTime=0,this.elapsedTime=0}initialize(){this.particles=[],this.burstCount=0,this.nextBurstTime=0,this.elapsedTime=0}createBurst(t,i,e=50){const s=["#FF0000","#FF7F00","#FFFF00","#00FF00","#0000FF","#4B0082","#9400D3"];for(let r=0;r<e;r++){const a=Math.PI*2*r/e,n=100+Math.random()*100;this.particles.push({x:t,y:i,vx:Math.cos(a)*n,vy:Math.sin(a)*n,color:s[Math.floor(Math.random()*s.length)],life:1,maxLife:1})}}update(t){if(this.elapsedTime+=t,this.burstCount<5&&this.elapsedTime>=this.nextBurstTime){const i=this.canvasWidth*(.2+Math.random()*.6),e=this.canvasHeight*(.2+Math.random()*.4);this.createBurst(i,e),this.burstCount++,this.nextBurstTime=this.elapsedTime+.5}for(let i=this.particles.length-1;i>=0;i--){const e=this.particles[i];e.x+=e.vx*t,e.y+=e.vy*t,e.vy+=200*t,e.life-=t*.8,e.life<=0&&this.particles.splice(i,1)}}getParticles(){return this.particles}isActive(){return this.particles.length>0||this.burstCount<5}}class H{constructor(){h(this,"gravity");h(this,"terminalVelocity");this.gravity=800,this.terminalVelocity=600}applyGravity(t,i){t.applyGravity(i)}checkGroundCollision(t,i){return t.y+t.height>=i&&t.velocityY>=0?(t.y=i-t.height,t.land(),!0):!1}resolveCollision(t,i){const e=i.checkCollision(t);if(!e.collided)return;const s=i.getBounds();switch(e.side){case"top":t.y=s.y-t.height,t.land();break;case"bottom":t.y=s.y+s.height,t.velocityY=0;break;case"left":t.x=s.x-t.width;break;case"right":t.x=s.x+s.width;break}}}class E{constructor(t){h(this,"timeRemaining");h(this,"isActive");h(this,"hasTriggered");h(this,"timeoutDuration");this.timeoutDuration=t,this.timeRemaining=t,this.isActive=!1,this.hasTriggered=!1}start(){this.isActive=!0,this.hasTriggered=!1}stop(){this.isActive=!1}reset(){this.timeRemaining=this.timeoutDuration,this.isActive=!1,this.hasTriggered=!1}update(t){return!this.isActive||this.hasTriggered?!1:(this.timeRemaining-=t,this.timeRemaining<0&&(this.timeRemaining=0),this.timeRemaining<=0&&!this.hasTriggered?(this.hasTriggered=!0,this.isActive=!1,!0):!1)}getTimeRemaining(){return this.timeRemaining}isTimedOut(){return this.hasTriggered}isTimerActive(){return this.isActive}}class O{constructor(t,i){h(this,"stages");h(this,"currentStageIndex");h(this,"titanicX");h(this,"titanicY");h(this,"icebergSplitOffset");h(this,"ghostSinkY");h(this,"isComplete");h(this,"canvasWidth");h(this,"canvasHeight");this.canvasWidth=t,this.canvasHeight=i,this.stages=[{name:"titanic-approach",duration:2,elapsed:0},{name:"collision",duration:.5,elapsed:0},{name:"iceberg-split",duration:1,elapsed:0},{name:"ghost-sink",duration:2,elapsed:0}],this.currentStageIndex=-1,this.titanicX=-200,this.titanicY=i*.1,this.icebergSplitOffset=0,this.ghostSinkY=0,this.isComplete=!1}start(){this.currentStageIndex=0,this.isComplete=!1;for(const t of this.stages)t.elapsed=0;this.titanicX=-200,this.titanicY=this.canvasHeight*.1,this.icebergSplitOffset=0,this.ghostSinkY=0}update(t){if(this.isComplete||this.currentStageIndex<0)return;const i=this.stages[this.currentStageIndex];switch(i.elapsed+=t,i.name){case"titanic-approach":const e=i.elapsed/i.duration;this.titanicX=-200+(this.canvasWidth/2-100)*Math.min(e,1);break;case"collision":const s=i.elapsed/i.duration,r=Math.sin(s*Math.PI*10)*5;this.titanicX=this.canvasWidth/2-100+r;break;case"iceberg-split":const a=i.elapsed/i.duration;this.icebergSplitOffset=50*Math.min(a,1);break;case"ghost-sink":const n=i.elapsed/i.duration;this.ghostSinkY=this.canvasHeight*Math.min(n,1);break}i.elapsed>=i.duration&&(this.currentStageIndex++,this.currentStageIndex>=this.stages.length&&(this.isComplete=!0))}isAnimationComplete(){return this.isComplete}getCurrentStage(){return this.currentStageIndex<0||this.currentStageIndex>=this.stages.length?null:this.stages[this.currentStageIndex]}getTitanicPosition(){return{x:this.titanicX,y:this.titanicY}}getIcebergSplitOffset(){return this.icebergSplitOffset}getGhostSinkY(){return this.ghostSinkY}reset(){this.currentStageIndex=-1,this.isComplete=!1;for(const t of this.stages)t.elapsed=0;this.titanicX=-200,this.titanicY=this.canvasHeight*.1,this.icebergSplitOffset=0,this.ghostSinkY=0}}class G{constructor(t){h(this,"canvas");h(this,"context");h(this,"character");h(this,"inputHandler");h(this,"renderer");h(this,"levelManager");h(this,"collisionDetector");h(this,"fireworksSystem");h(this,"physicsSystem");h(this,"timeoutManager");h(this,"titanicAnimationSystem");h(this,"gameStatus");h(this,"isRunning");h(this,"currentLevel");h(this,"trapdoor");h(this,"chalice");h(this,"obstacles");h(this,"door");h(this,"seaCreatures");h(this,"lastFrameTime");h(this,"animationFrameId");this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Failed to get canvas 2D context");this.context=i,this.inputHandler=new Y,this.renderer=new D(t.width,t.height),this.levelManager=new W(t.width,t.height),this.collisionDetector=new I,this.fireworksSystem=new B(t.width,t.height),this.physicsSystem=new H,this.timeoutManager=new E(15),this.titanicAnimationSystem=new O(t.width,t.height),this.gameStatus="playing",this.isRunning=!1,this.currentLevel=0,this.trapdoor=null,this.chalice=null,this.obstacles=[],this.door=null,this.seaCreatures=[],this.lastFrameTime=0,this.animationFrameId=null;const e=40,s=35,r=t.height*.1,a=t.width/2-s/2,n=r*.5-e;this.character=new F(a,n,s,e,u.HORIZONTAL_SPEED,t.width,0),this.initializeLevel(0)}initializeLevel(t){if(this.currentLevel=t,this.character.setLevel(t),t===0){this.obstacles=[],this.chalice=null;const i=this.canvas.height*.1,e=this.canvas.width/2-30,s=i*.3;this.door=new b(e,s,60,80),this.seaCreatures=[];for(let r=0;r<3;r++)this.seaCreatures.push(new w(1,this.canvas.width,this.canvas.height));this.character.x=this.canvas.width/2-this.character.width/2,this.character.y=i*.8-this.character.height,this.character.velocityY=0,this.character.isJumping=!1,this.character.isOnGround=!0,this.timeoutManager.start()}else{this.obstacles=this.levelManager.generateObstacles(t),this.door=this.levelManager.generateDoor(t),this.chalice=this.levelManager.generateChalice(t),this.seaCreatures=[];for(let i=0;i<t+1;i++)this.seaCreatures.push(new w(t,this.canvas.width,this.canvas.height));this.character.x=50,this.character.y=u.GROUND_Y-this.character.height,this.character.velocityY=0,this.character.isJumping=!1,this.character.isOnGround=!0}this.trapdoor=null}transitionToLevel(t){const i=Math.max(1,Math.min(6,t));this.currentLevel===0&&i>0&&this.timeoutManager.stop(),this.gameStatus="transitioning",setTimeout(()=>{this.initializeLevel(i),this.gameStatus="playing"},300)}triggerWin(){this.gameStatus="won",this.fireworksSystem.initialize()}triggerLose(){this.gameStatus="lost"}handleTimeout(){this.gameStatus="timeout-animating",this.titanicAnimationSystem.start()}restartFromTimeout(){this.gameStatus="playing",this.timeoutManager.reset(),this.titanicAnimationSystem.reset(),this.initializeLevel(0),this.timeoutManager.start()}start(){this.isRunning||(this.isRunning=!0,this.inputHandler.initialize(),this.lastFrameTime=performance.now(),this.gameLoop(this.lastFrameTime))}stop(){this.isRunning=!1,this.inputHandler.cleanup(),this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}gameLoop(t){if(!this.isRunning)return;const i=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.update(i),this.render(),this.animationFrameId=requestAnimationFrame(e=>this.gameLoop(e))}update(t){if(this.inputHandler.update(),this.gameStatus==="playing")if(this.currentLevel===0){const i=this.inputHandler.getActiveDirection();i&&this.character.move(i,t),this.character.updateRotationOnly(t);for(const s of this.seaCreatures)s.update(t,this.canvas.width);if(this.timeoutManager.update(t)){this.handleTimeout();return}this.door&&this.collisionDetector.checkDoorOverlap(this.character,this.door)&&this.inputHandler.isEnterPressed()&&(this.inputHandler.consumeEnter(),this.transitionToLevel(1))}else{this.inputHandler.isSpacePressed()&&this.character.isOnGround&&(this.character.jump(),this.inputHandler.consumeSpace());const i=this.inputHandler.getActiveDirection();i&&this.character.move(i,t),this.character.updatePhysics(t),this.physicsSystem.checkGroundCollision(this.character,u.GROUND_Y);for(const e of this.seaCreatures)e.update(t,this.canvas.width);this.checkCollisions()}else this.gameStatus==="won"?this.fireworksSystem.update(t):this.gameStatus==="timeout-animating"?(this.titanicAnimationSystem.update(t),this.titanicAnimationSystem.isAnimationComplete()&&(this.gameStatus="timeout-gameover")):this.gameStatus==="timeout-gameover"&&this.inputHandler.isEnterPressed()&&(this.inputHandler.consumeEnter(),this.restartFromTimeout())}checkCollisions(){for(const t of this.obstacles)this.physicsSystem.resolveCollision(this.character,t);this.door&&this.collisionDetector.checkDoorOverlap(this.character,this.door)&&this.inputHandler.isEnterPressed()&&(this.inputHandler.consumeEnter(),this.transitionToLevel(this.currentLevel+1)),this.chalice&&!this.chalice.collected&&this.collisionDetector.checkChaliceCollision(this.character,this.chalice)&&(this.chalice.collected=!0,this.triggerWin()),this.character.y>this.canvas.height&&this.triggerLose()}render(){if(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentLevel===0){if(this.renderer.drawBackground(this.context,1),this.renderer.drawSeaCreatures(this.context,this.seaCreatures),this.door){const i=this.door.checkOverlap(this.character);this.renderer.drawDoor(this.context,this.door,i)}this.renderer.drawCharacter(this.context,this.character),this.context.save();const t=this.canvas.height-120;this.context.fillStyle="rgba(0, 0, 0, 0.7)",this.context.fillRect(this.canvas.width/2-200,t,400,80),this.context.strokeStyle="#FFD700",this.context.lineWidth=2,this.context.strokeRect(this.canvas.width/2-200,t,400,80),this.context.fillStyle="#FFFFFF",this.context.font="bold 28px Arial",this.context.textAlign="center",this.context.fillText("Tip of the Iceberg",this.canvas.width/2,t+30),this.context.font="18px Arial",this.context.fillText("Enter the door to begin",this.canvas.width/2,t+60),this.context.restore()}else{this.renderer.drawBackground(this.context,this.currentLevel),this.renderer.drawSeaCreatures(this.context,this.seaCreatures),this.renderer.drawGround(this.context,u.GROUND_Y);for(const t of this.obstacles)this.renderer.drawObstacle(this.context,t);if(this.door){const t=this.door.checkOverlap(this.character);this.renderer.drawDoor(this.context,this.door,t)}this.chalice&&this.renderer.drawChalice(this.context,this.chalice),this.renderer.drawCharacter(this.context,this.character),this.renderer.drawLevelBanner(this.context,this.currentLevel)}this.gameStatus==="won"?(this.renderer.drawFireworks(this.context,this.fireworksSystem.getParticles()),this.renderer.drawWinScreen(this.context)):this.gameStatus==="lost"?this.renderer.drawLoseScreen(this.context):this.gameStatus==="timeout-animating"?this.renderTimeoutAnimation():this.gameStatus==="timeout-gameover"&&this.renderer.drawTimeoutGameOver(this.context)}renderTimeoutAnimation(){const t=this.titanicAnimationSystem.getCurrentStage();if(!t)return;this.renderer.drawBackground(this.context,1),this.renderer.drawSeaCreatures(this.context,this.seaCreatures);const i=this.titanicAnimationSystem.getTitanicPosition(),e=this.titanicAnimationSystem.getIcebergSplitOffset(),s=this.titanicAnimationSystem.getGhostSinkY();switch(t.name){case"titanic-approach":case"collision":this.renderer.drawTitanic(this.context,i.x,i.y);break;case"iceberg-split":this.renderer.drawTitanic(this.context,i.x,i.y),this.renderer.drawSplitIceberg(this.context,e),this.renderer.drawCharacter(this.context,this.character);return;case"ghost-sink":this.renderer.drawSplitIceberg(this.context,e),this.renderer.drawSinkingGhost(this.context,this.character,s);return}this.renderer.drawCharacter(this.context,this.character)}getState(){return{status:this.gameStatus,isRunning:this.isRunning,currentLevel:this.currentLevel,character:this.character,trapdoor:this.trapdoor,chalice:this.chalice,canvas:this.canvas,context:this.context,lastFrameTime:this.lastFrameTime}}}function S(){const o=document.getElementById("gameCanvas");if(!o){console.error("Canvas element not found");return}try{const t=new G(o);t.start(),console.log("Tip of the Iceberg - Game started successfully!"),window.game=t}catch(t){console.error("Failed to initialize game:",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S();
